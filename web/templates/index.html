<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <!-- <script src="JStuff.js"></script>  -->
        <script src="https://unpkg.com/vue"></script>
        <title> Codebot | Welcome</title>
        <link rel="stylesheet" href="../static/css/styles.css" />
    </head>

    <script src="static/js/build.js"></script>

    <script type="text/javascript">
        var level = {{ grid | tojson | safe }};
    </script>

    </head>

    <body>
        <header>
            <div class="container">
                <div id="branding">
                    <img id="favicon" src="../static/assets/favicon.png" />
                    <h1> Welcome to <span>Codebot!</span></h1>
                </div>
                <nav>
                    <ul>
                        <li class="current"><a href="level0">Home</a></li>
                        <li><a href="challenges">Challenges</a></li>
                        <li><a href="myProfile">My Profile</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Everything for the code and the game display -->
        <section id="main">
            <!-- The code Box -->
            <div class="codeContainer">
                <form id="codeBox">
                    <fieldset>
                        <!-- <legend> Enter code here </legend> -->
                        <h2> Code </h2>
                        <p>
                            <textarea v-model="codeBox" id="code_area" placeholder="Enter Code"></textarea>
                        </p>
                    </fieldset>

                    <input id="button_1" type="button" value="Run!" v-on:click="uiRunGame" />
                    <input id="button_1" type="button" value="Step Through" onclick="stepThrough();" />
                    <input id="button_1" type="button" value="Reset" onclick="resetLevel();" />
                </form>

                <!-- The game display -->
                <div class="gridContainer">
                    <table>
                        <tr v-for="row in levelMap">
                            <td v-for="col in row">
                                <div style="position: relative;">
                                    <img src="../static/assets/grass/grass3.png" id="cell">
                                    <img v-for="sprite in col" v-bind:src="sprite" id="cell" style="position: absolute; top: 0; left: 0;"/>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>

            </div>
        </section>

        <!-- Vue object setup -->
        <script>
            // initialise
            var grid = new World.Grid( level.numRows, level.numCols,
                new World.Coord2D( level.goal.x, level.goal.y ),
                new World.Coord2D( level.start.x, level.start.y ),
                World.Direction[ level.startDir ]);
            var sprites = {
                grass: function(){
                    return "../static/assets/grass/grass1.png";
                },
                player: {
                    Up: "../static/assets/playerSprite/up.png",
                    Down: "../static/assets/playerSprite/down.png",
                    Left: "../static/assets/playerSprite/left.png",
                    Right: "../static/assets/playerSprite/right.png"
                },
                goal: "../static/assets/goal.png"
            };

            //vue
            var game = new Vue({
                el: "#main",
                data: {
                    levelMap: grid.render(sprites),
                        // [grass1, grass1, grass1, grass1, grass1],
                        // [grass1, grass1, grass1, grass1, grass1],
                        // [spriteD, grass1, grass1, grass1, grass1],
                        // [grass1, grass1, grass1, grass1, grass1],
                        // [grass1, grass1, grass1, grass1, grass1]
                    //],
                  codeBox: "// Write some code!" // Replace with level starter code
                },
                methods: {
                    uiRunGame: function() {

                        //setup inputs
                        // var code = document.getElementById('code_area').value;
                        var code = this.codeBox;

                        //Replace later when main.ts is done
                        var ast = Parser.parseAST([], [], code).ast;

                        this.codeBox = Parser.prettyPrint(ast);

                        var gen = Interpreter.runInterpreter(grid, ast,
                            //level command set goes in this array
                            [PS.Interpreter.environment.moveLeft,
                            PS.Interpreter.environment.moveRight,
                            PS.Interpreter.environment.moveUp,
                            PS.Interpreter.environment.moveDown]);

                        var self = this;

                        //iterate
                        var interval = setInterval( function() {
                            world = gen.next().value;

                            if (world === undefined) {
                                clearInterval(interval); //break
                            }else{
                                self.levelMap=world.render(sprites);
                                console.log(self.levelMap);

                                if (world.victory() || world.failed() || world === undefined) {
                                    clearInterval(interval); //break
                                }
                            }
                        }, 500);
                    }
                }
            });

        </script>

        <footer>
            <div><p> <strong>COMP-4920</strong> Project - Term 2, 2017 </p></div>
            <div><p>  <strong>Authors</strong> </br> Joshua Lau, Macka Baran, Josh Meredith, Matthieu Capuano </p></div>
            <div><p> Copyright &copy; 2017 </p></div>
        </footer>
    </body>
</html>
