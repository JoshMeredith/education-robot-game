<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <!-- <script src="JStuff.js"></script>  -->
        <script src="https://unpkg.com/vue"></script>
        <title> Codebot | Welcome</title>
        <link rel="stylesheet" href="../static/css/styles.css" />
    </head>

    <script src="static/js/build.js"></script>

    <script type="text/javascript">
        var level = {{ grid | tojson | safe }};
    </script>

    </head>

    <body>
        <header>
            <div class="container">
                <div id="branding">
                    <img id="favicon" src="../static/assets/favicon.png" />
                    <h1> Welcome to <span>Codebot!</span></h1>
                </div>
                <nav>
                    <ul>
                        <li class="current"><a href="level0">Home</a></li>
                        <li><a href="challenges">Challenges</a></li>
                        <li><a href="myProfile">My Profile</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Everything for the code and the game display -->
        <section id="main">
            <!-- The code Box -->
            <div class="codeContainer">
                <form id="codeBox">
                    <fieldset>
                        <legend> Level 0 </legend> <!-- TODO: Hardcoded, fix! -->
                        <h2> Code </h2>
                        <p>
                            <textarea v-model="codeBox" id="code_area" placeholder="Enter Code"></textarea>
                        </p>
                    </fieldset>

                    <input id="button_1" type="button" value="Run!" v-on:click="uiRunGame" />
                    <input id="button_1" type="button" value="Step Through" onclick="stepThrough();" />
                    <input id="button_1" type="button" value="Reset" v-on:click="resetLevel" />
                    <input id="button_1" type="button" value="Next Challenge" onclick="nextChallenge" />
                </form>

                <!-- The game display -->
                <div  class="gridContainer">
                    <table v-if="!gameOver">
                        <tr v-for="row in levelMap">
                            <td v-for="col in row">
                                <div style="position: relative;">
                                    <img src="../static/assets/grass/grass3.png" id="cell">
                                    <img v-for="sprite in col" v-bind:src="sprite" id="cell" style="position: absolute; top: 0; left: 0;"/>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div v-else-if="gameOver && victory" class="winMessage">
                        <p style="font-size:50px; margin: 0;">Congratulations!</p>
                        <p>You beat the level.</p>
                        <input type="button" value="Next Level" v-on:click="nextLevel" />   
                    </div>

                    <div v-else-if="gameOver && !victory" class="lossMessage">
                        <p style="font-size:50px; margin: 0;">Oh no!</p>
                        <p>Codebot didn't reach the goal.</p>
                        <p>Try Again!</p>  
                        <div>
                            <input type="button" value="View Map" v-on:click="viewMap" />
                            <input type="button" value="Reset" v-on:click="resetLevel" />
                        </div>
                    </div>

                </div>

            </div>
        </section>

        <!-- Vue object setup -->
        <script>
            // initialise
            var grid = new World.Grid( level.numRows, level.numCols,
                new World.Coord2D( level.goal.x, level.goal.y ),
                new World.Coord2D( level.start.x, level.start.y ),
                World.Direction[ level.startDir ]);
            var sprites = {
                grass: function(){
                    return "../static/assets/grass/grass1.png";
                },
                player: {
                    Up: "../static/assets/playerSprite/up.png",
                    Down: "../static/assets/playerSprite/down.png",
                    Left: "../static/assets/playerSprite/left.png",
                    Right: "../static/assets/playerSprite/right.png"
                },
                goal: "../static/assets/goal.png"
            };



            //vue
            var game = new Vue({
                el: "#main",
                data: {
                    levelMap: grid.render(sprites),
                    codeBox: "// Write some code!", // Replace with level starter code
                    gameOver: false, 
                    victory: false,
                    stepThroughMode: false,
                },
                methods: {
                    viewMap: function(){
                        var self = this;
                        self.gameOver=false;
                    },
                    resetLevel: function() {
                        var self = this;
                        self.gameOver=false;
                        self.levelMap= grid.render(sprites);
                    },
                    stepThrough: function() {
                        
                    },
                    uiRunGame: function() {

                        //setup inputs
                        var code = this.codeBox;
                        var ast = Parser.parseAST([], [], code).ast;
                        this.codeBox = Parser.prettyPrint(ast);

                        var gen = Interpreter.runInterpreter(grid, ast,
                            //level command set goes in this array
                            [PS.Interpreter.environment.moveLeft,
                            PS.Interpreter.environment.moveRight,
                            PS.Interpreter.environment.moveUp,
                            PS.Interpreter.environment.moveDown]);

                        var self = this;

                        //iterate
                        var interval = setInterval( function() {
                            world = gen.next().value;

                            if (world === undefined) {
                                self.gameOver=true;
                                clearInterval(interval); //break
                            }else{
                                self.levelMap=world.render(sprites);

                                if ( world.victory() || world.failed() ) {
                                    self.gameOver=true;
                                    if ( world.victory() ) { self.victory=true; }

                                    clearInterval(interval); //break
                                }
                            }
                        }, 500);

                    }
                }
            });

        </script>

        <footer>
            <div><p> <strong>COMP-4920</strong> Project - Term 2, 2017 </p></div>
            <div><p>  <strong>Authors</strong> </br> Joshua Lau, Macka Baran, Josh Meredith, Matthieu Capuano </p></div>
            <div><p> Copyright &copy; 2017 </p></div>
        </footer>
    </body>
</html>
